name: Dotfiles CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  lint-all:
    name: Comprehensive Lint Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install lint tools
        run: |
          # Install ShellCheck
          sudo apt-get update && sudo apt-get install -y shellcheck

          # Install Python linters via pip
          pip install yamllint

          # Install markdownlint-cli
          npm install -g markdownlint-cli

      - name: Lint Shell Scripts
        run: |
          echo "=== ShellCheck Analysis ==="
          exit_code=0
          for script in $(find . -name "*.sh" -type f); do
            echo "Checking: $script"
            shellcheck -S warning "$script" || exit_code=1
          done
          exit $exit_code

      - name: Lint YAML Files
        run: |
          echo "=== YAML Lint ==="
          yamllint -d relaxed -f colored .

      - name: Lint Markdown Files
        run: |
          echo "=== Markdown Lint ==="
          markdownlint '**/*.md' --ignore node_modules || true

      - name: Universal File Type Validation
        run: |
          echo "=== Universal File Type Validation ==="

          # Function to safely check files
          check_files() {
            local pattern="$1"
            local description="$2"
            local validator="$3"

            local files=$(find . -name "$pattern" -type f 2>/dev/null | grep -v -E '\.(git|node_modules)/' || true)
            if [ -n "$files" ]; then
              echo "Found $description files:"
              echo "$files" | sed 's/^/  - /'
              echo "$files" | while IFS= read -r file; do
                echo "Validating: $file"
                eval "$validator \"$file\"" || return 1
              done
            else
              echo "No $description files found - skipping"
            fi
          }

          # Install validation tools
          echo "Installing validation tools..."
          sudo apt-get update -qq
          sudo apt-get install -y luarocks libxml2-utils >/dev/null 2>&1
          sudo luarocks install luacheck >/dev/null 2>&1
          pip install tomli >/dev/null 2>&1

          # Validate different file types
          exit_code=0

          # Lua files (Neovim configs)
          echo -e "\n🔍 Lua Files:"
          check_files "*.lua" "Lua" "luacheck --globals vim" || exit_code=1

          # JSON files
          echo -e "\n🔍 JSON Files:"
          check_files "*.json" "JSON" "python -m json.tool > /dev/null" || exit_code=1

          # TOML files
          echo -e "\n🔍 TOML Files:"
          check_files "*.toml" "TOML" "python -c \"import tomli; tomli.load(open('\$1', 'rb'))\"" || exit_code=1

          # Special files validation
          echo -e "\n🔍 Special Configuration Files:"

          # Brewfile validation
          if [ -f "Brewfile" ]; then
            echo "Validating Brewfile..."
            if grep -E '^(tap|brew|cask)\s+' Brewfile >/dev/null && \
               [ $(grep -E '^(brew|cask)\s+' Brewfile | sort | uniq -d | wc -l) -eq 0 ]; then
              echo "✓ Brewfile is valid"
            else
              echo "✗ Brewfile has issues"
              exit_code=1
            fi
          fi

          # Dynamic dotfiles validation (only check files that exist)
          for config_file in .tmux.conf .zshrc .gitconfig; do
            if [ -f "$config_file" ]; then
              echo "Validating $config_file..."
              case "$config_file" in
                .tmux.conf)
                  if command -v tmux >/dev/null 2>&1; then
                    tmux -f "$config_file" list-keys >/dev/null 2>&1 && echo "✓ $config_file syntax valid" || echo "⚠ $config_file may have issues"
                  else
                    echo "⚠ tmux not available for validation"
                  fi
                  ;;
                .gitconfig)
                  git config --file "$config_file" --list >/dev/null 2>&1 && echo "✓ $config_file syntax valid" || { echo "✗ $config_file has errors"; exit_code=1; }
                  ;;
                .zshrc)
                  # Basic syntax check only
                  bash -n "$config_file" 2>/dev/null && echo "✓ $config_file basic syntax valid" || echo "⚠ $config_file may have issues"
                  ;;
              esac
            fi
          done

          exit $exit_code

  go-lint:
    name: Go Code Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Go Code Validation
        run: |
          echo "=== Go Code Validation ==="

          # Check if any Go files exist
          go_files=$(find . -name "*.go" -type f 2>/dev/null | grep -v vendor/ || true)
          go_modules=$(find . -name "go.mod" -type f 2>/dev/null || true)

          if [ -n "$go_files" ]; then
            echo "Found Go files:"
            echo "$go_files" | sed 's/^/  - /'

            # Setup Go environment
            export PATH=$PATH:$(go env GOPATH)/bin

            # Install linting tools
            echo "Installing Go linting tools..."
            curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.54.2 >/dev/null 2>&1

            # Run comprehensive Go validation
            exit_code=0

            # 1. Format check
            echo "🔍 Checking Go formatting..."
            unformatted=$(gofmt -l . 2>/dev/null | grep -v vendor/ || true)
            if [ -n "$unformatted" ]; then
              echo "✗ Unformatted Go files found:"
              echo "$unformatted" | sed 's/^/  - /'
              exit_code=1
            else
              echo "✓ All Go files are properly formatted"
            fi

            # 2. Go vet (static analysis)
            echo "🔍 Running go vet..."
            if go vet ./... 2>/dev/null; then
              echo "✓ go vet passed"
            else
              echo "✗ go vet found issues"
              exit_code=1
            fi

            # 3. Linting (if available)
            echo "🔍 Running golangci-lint..."
            if golangci-lint run --timeout=5m 2>/dev/null; then
              echo "✓ golangci-lint passed"
            else
              echo "⚠ golangci-lint found issues (non-blocking)"
            fi

            # 4. Security check (if go.mod exists)
            if [ -n "$go_modules" ]; then
              echo "🔍 Running security scan..."
              go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest >/dev/null 2>&1
              if gosec ./... >/dev/null 2>&1; then
                echo "✓ Security scan passed"
              else
                echo "⚠ Security issues found (review recommended)"
              fi
            fi

            exit $exit_code
          else
            echo "No Go files found - skipping Go validation"
          fi

      - name: Check file permissions
        run: |
          echo "=== File Permissions Check ==="
          # Check that shell scripts are executable
          for script in $(find . -name "*.sh" -type f); do
            if [ ! -x "$script" ]; then
              echo "Warning: $script is not executable"
            fi
          done

  shellcheck:
    name: Shell Script Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          # Install shellcheck if not available
          if ! command -v shellcheck &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y shellcheck
          fi

          # Run shellcheck only on bash scripts, excluding .zshrc and other non-bash files
          exit_code=0
          for script in *.sh; do
            if [ -f "$script" ]; then
              echo "Checking: $script"
              shellcheck -S warning "$script" || exit_code=1
            fi
          done
          exit $exit_code

  bash-syntax:
    name: Bash Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check bash syntax
        run: |
          exit_code=0
          found_scripts=false

          for script in *.sh; do
            if [ -f "$script" ]; then
              found_scripts=true
              echo "Checking syntax: $script"
              bash -n "$script" || exit_code=1
            fi
          done

          if [ "$found_scripts" = "false" ]; then
            echo "No shell scripts found to check"
          fi

          exit $exit_code

  zsh-syntax:
    name: Zsh Configuration Check
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install validation tools
        run: |
          # Install uv for fast Python package management
          brew install uv || true

          # Install beautysh for shell formatting checks
          uv tool install beautysh --with setuptools

          # Add uv tools to PATH
          export PATH="$HOME/.local/bin:$PATH"

          # Verify installation
          which beautysh || echo "beautysh not in PATH"

      - name: Check .zshrc with multiple validators
        run: |
          if [ -f .zshrc ]; then
            echo "=== Zsh Configuration Validation ==="
            exit_code=0

            # 1. Native zsh syntax check
            echo "→ Running zsh native syntax check..."
            if zsh -n .zshrc 2>&1; then
              echo "  ✓ Zsh syntax is valid"
            else
              echo "  ✗ Zsh syntax errors found"
              exit_code=1
            fi

            # 2. Check with zsh extended debugging
            echo "→ Running extended validation..."
            if zsh -x -c "source .zshrc" 2>&1 | head -n 0; then
              echo "  ✓ No critical errors during sourcing"
            fi

            # 3. Use beautysh for formatting checks (works with zsh)
            echo "→ Running beautysh format check..."
            # Add beautysh to PATH if needed
            export PATH="$HOME/.local/bin:$PATH"
            if PYTHONWARNINGS="ignore" beautysh --check .zshrc 2>/dev/null; then
              echo "  ✓ Format check passed"
            else
              echo "  ⚠ Format issues detected"
              # Show the diff for debugging
              PYTHONWARNINGS="ignore" beautysh --check .zshrc 2>&1 | grep -A5 -B5 "@@" || true
              exit_code=1
            fi

            # 4. Static analysis for common issues
            echo "→ Checking for common anti-patterns..."
            issues_found=0

            # Check for undefined variables
            if grep -E '\$[a-zA-Z_][a-zA-Z0-9_]*' .zshrc | grep -v '\${' | grep -v '\$(' | grep -v '\$PATH' | grep -v '\$HOME' > /dev/null; then
              echo "  ⚠ Potential undefined variables found"
            fi

            # Check for command substitution using backticks
            if grep '`.*`' .zshrc > /dev/null; then
              echo "  ⚠ Found backticks - consider using $(command) syntax"
              issues_found=$((issues_found + 1))
            fi

            # Check for proper quoting
            if grep -E 'echo [^"]*\$' .zshrc > /dev/null; then
              echo "  ⚠ Potential unquoted variables in echo statements"
            fi

            if [ $issues_found -eq 0 ]; then
              echo "  ✓ No critical anti-patterns found"
            fi

            # 5. Validate using zsh's built-in warn options
            echo "→ Running with warning flags..."
            if zsh -o WARN_CREATE_GLOBAL -o WARN_NESTED_VAR -c "source .zshrc" 2>&1 | grep -q "warning"; then
              echo "  ⚠ Warnings detected (review recommended)"
            else
              echo "  ✓ No warnings with strict flags"
            fi

            echo "=== Validation complete ==="
            exit $exit_code
          else
            echo "No .zshrc file found - skipping"
          fi

  yaml-validation:
    name: YAML/Plist Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate YAML files
        run: |
          # Install yamllint
          pip install yamllint

          # Check if there are any YAML files to validate
          yaml_files=$(find . -type f \( -name "*.yml" -o -name "*.yaml" \) ! -path "./.git/*")
          if [ -n "$yaml_files" ]; then
            echo "Validating YAML files:"
            echo "$yaml_files"
            yamllint -d relaxed $yaml_files || true  # Don't fail on style issues
          else
            echo "No YAML files found to validate"
          fi

      - name: Check plist files
        run: |
          # Install xmllint if not available
          if ! command -v xmllint &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y libxml2-utils
          fi

          for plist in $(find . -name "*.plist"); do
            echo "Checking: $plist"
            # Basic XML validation
            xmllint --noout "$plist" || exit 1
          done

  bootstrap-test:
    name: Bootstrap Script Test
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy bootstrap script to test location
        run: |
          # Create test home directory structure
          export TEST_HOME=$GITHUB_WORKSPACE/test_home
          mkdir -p $TEST_HOME/.config/yadm

          # Copy bootstrap script if it exists
          if [ -f ".config/yadm/bootstrap" ]; then
            cp .config/yadm/bootstrap $TEST_HOME/.config/yadm/bootstrap
            chmod +x $TEST_HOME/.config/yadm/bootstrap
          else
            echo "Warning: bootstrap script not found at .config/yadm/bootstrap"
            exit 1
          fi

          # Copy test-bootstrap.sh if it exists
          if [ -f "test-bootstrap.sh" ]; then
            cp test-bootstrap.sh $TEST_HOME/test-bootstrap.sh
            chmod +x $TEST_HOME/test-bootstrap.sh
          fi

          # Copy other required files for bootstrap testing
          for file in Brewfile .tmux.conf daily-maintenance.sh daily-maintenance-control.sh install-daily-maintenance.sh; do
            if [ -f "$file" ]; then
              cp "$file" "$TEST_HOME/"
            fi
          done

          # Copy config files
          if [ -d ".config/ghostty" ]; then
            mkdir -p $TEST_HOME/.config/ghostty
            cp .config/ghostty/* $TEST_HOME/.config/ghostty/ 2>/dev/null || true
          fi

      - name: Run bootstrap tests
        run: |
          export HOME=$GITHUB_WORKSPACE/test_home
          cd $HOME

          # Run the bootstrap test script
          if [ -f "test-bootstrap.sh" ]; then
            echo "Running bootstrap test suite..."
            bash test-bootstrap.sh
          else
            echo "test-bootstrap.sh not found, running basic tests..."
            # Fallback to basic tests
            echo "Testing bootstrap syntax..."
            bash -n .config/yadm/bootstrap
            echo "Bootstrap syntax check passed"
          fi

  macos-integration:
    name: macOS Integration Tests
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test installation script (dry run)
        run: |
          # Create a test environment
          export CI_TEST=true
          export TEST_HOME=$GITHUB_WORKSPACE/test_home
          mkdir -p $TEST_HOME
          mkdir -p $TEST_HOME/Library/LaunchAgents
          mkdir -p $TEST_HOME/Library/Logs

          # Check which files exist and copy them
          echo "Files in current directory:"
          ls -la *.sh 2>/dev/null || echo "No .sh files found"

          # Copy files to test location if they exist
          for file in daily-maintenance.sh daily-maintenance-control.sh install-daily-maintenance.sh uninstall-daily-maintenance.sh test-dotfiles.sh; do
            if [ -f "$file" ]; then
              echo "Copying $file to $TEST_HOME/"
              cp "$file" "$TEST_HOME/"
              chmod +x "$TEST_HOME/$file"
            else
              echo "Warning: $file not found"
            fi
          done

          # Copy plist template if it exists
          if [ -f "Library/LaunchAgents/com.daily-maintenance.plist.template" ]; then
            cp Library/LaunchAgents/*.plist.template $TEST_HOME/Library/LaunchAgents/
          else
            echo "Warning: plist template file not found"
          fi

          # Test syntax for files that exist
          for script in daily-maintenance.sh daily-maintenance-control.sh install-daily-maintenance.sh uninstall-daily-maintenance.sh; do
            if [ -f "$TEST_HOME/$script" ]; then
              echo "Testing syntax: $script"
              bash -n "$TEST_HOME/$script"
            else
              echo "Skipping $script - not found"
            fi
          done

      - name: Validate LaunchAgent plist template
        run: |
          if [ -f Library/LaunchAgents/com.daily-maintenance.plist.template ]; then
            # Create temp file with substituted values for validation
            sed "s|{{HOME}}|$HOME|g" Library/LaunchAgents/com.daily-maintenance.plist.template > /tmp/test.plist
            plutil -lint /tmp/test.plist
            rm /tmp/test.plist
          else
            echo "Warning: plist template not found"
          fi

      - name: Test daily-maintenance.sh functions
        run: |
          # Test the run_command function in isolation
          cat > test_maintenance.sh << 'EOF'
          #!/bin/bash
          source ./daily-maintenance.sh 2>/dev/null || true

          # Test the run_command function
          run_command() {
              local description="$1"
              shift
              local command="$@"

              echo "Testing: $description"
              echo "Command: $command"
              return 0
          }

          # Test function calls
          run_command "Test command" echo "test"
          EOF

          chmod +x test_maintenance.sh
          bash test_maintenance.sh

  documentation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "ERROR: README.md not found"
            exit 1
          fi

      - name: Validate markdown
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: '**/*.md'
        continue-on-error: true  # Don't fail on markdown style issues

      - name: Check for broken links in README
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          check-modified-files-only: 'yes'
        continue-on-error: true

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy security scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true

  compatibility-matrix:
    name: Compatibility Test
    strategy:
      matrix:
        os: [macos-14, macos-15, macos-latest]
      fail-fast: false  # Continue testing other OS even if one fails
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check script compatibility
        run: |
          echo "Testing on ${{ matrix.os }}"

          # Show detailed system info
          echo "System information:"
          sw_vers || true
          echo "Architecture: $(uname -m)"

          # Test bash version compatibility
          echo "Bash version:"
          bash --version

          # Check for script syntax on this OS
          found_scripts=false
          for script in *.sh; do
            if [ -f "$script" ]; then
              found_scripts=true
              echo "Checking: $script on ${{ matrix.os }}"
              bash -n "$script" || exit 1
            fi
          done

          if [ "$found_scripts" = "false" ]; then
            echo "No shell scripts found to test"
          fi

  summary:
    name: CI Summary
    needs: [lint-all, shellcheck, bash-syntax, zsh-syntax, yaml-validation, go-lint, bootstrap-test, macos-integration, documentation, security-scan, compatibility-matrix]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## CI Pipeline Summary"
          echo "All validation checks completed."
          echo "Check individual job results above for details."
