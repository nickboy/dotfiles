#!/usr/bin/env bash
set -euo pipefail

# Claude Code notification helper.
# Works in: Ghostty direct, Neovim terminal, tmux, SSH remote.
#
# Strategy:
# 1. Walk up process tree to find outermost TTY (bypasses Neovim pty)
# 2. Fall back to /dev/tty if no parent TTY found (direct terminal/SSH)
# 3. Send desktop notification via osascript (macOS) or notify-send (Linux)

bell_sent=false
my_tty=$(command -p ps -o tty= -p $$ 2>/dev/null | tr -d ' ')
pid=$$

# Walk up the process tree to find a parent on a different TTY
while [ "$pid" -gt 1 ]; do
  pid=$(command -p ps -o ppid= -p "$pid" 2>/dev/null | tr -d ' ')
  [ -z "$pid" ] && break
  parent_tty=$(command -p ps -o tty= -p "$pid" 2>/dev/null | tr -d ' ')
  if [ -n "$parent_tty" ] && [ "$parent_tty" != "??" ] && [ "$parent_tty" != "$my_tty" ]; then
    printf '\a' > "/dev/$parent_tty" 2>/dev/null && bell_sent=true
    break
  fi
done

# Fallback: direct terminal or SSH (no Neovim in the way)
if [ "$bell_sent" = false ]; then
  printf '\a' > /dev/tty 2>/dev/null || true
fi

# Desktop notification (platform-aware)
if command -v osascript &>/dev/null; then
  osascript -e 'display notification "Claude Code needs your attention" with title "Claude Code"' 2>/dev/null || true
elif command -v notify-send &>/dev/null; then
  notify-send "Claude Code" "Claude Code needs your attention" 2>/dev/null || true
fi
